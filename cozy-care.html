<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Starry Night ‚Äî For Divanshi</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Patrick+Hand&display=swap" rel="stylesheet">

<style>
:root{
  --bg-deep-1:#02061a;
  --bg-deep-2:#07112a;
  --accentA:#ff78b2;
  --accentB:#ff57a0;
  --glass: rgba(255,255,255,0.04);
  --muted:#b07aa6;
  --soft-white: rgba(255, 245, 255, 0.94);
  --affirm-accent: rgba(255,120,180,0.14);

  /* new tuning variables */
  --galaxy-a: #2a3d73;
  --galaxy-b: #1b2760;
  --galaxy-c: #0a0930;
  --title-glow: rgba(255,192,203,0.9);
  --title-glow-2: rgba(255,105,180,0.8);
}

/* ---------- page base (keeps your background but now pulsates) ---------- */
html,body {
  height:100%;
  margin:0;
  background: linear-gradient(180deg, var(--galaxy-a) 0%, var(--galaxy-b) 60%, var(--galaxy-c) 100%);
  color:var(--soft-white);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:auto;
  -webkit-font-feature-settings: "liga";
  -moz-osx-font-smoothing: grayscale;
}

/* Subtle animated galaxy glow to make nights less flat */
@keyframes galaxyPulse {
  0%,100% { filter: hue-rotate(0deg) brightness(1); }
  50%   { filter: hue-rotate(6deg) brightness(1.04) saturate(1.04); }
}
body { animation: galaxyPulse 18s ease-in-out infinite; }

/* ---------- Pulsing glow for Cozy Care title (targeting .title) ---------- */
.cozy-title {
  animation: titleGlow 3s ease-in-out infinite;
}
@keyframes titleGlow {
  0%, 100% { text-shadow: 0 0 8px var(--title-glow), 0 0 16px var(--title-glow-2); }
  50%     { text-shadow: 0 0 14px rgba(255,192,203,1), 0 0 28px rgba(255,105,180,0.85); }
}

/* ---------- Shooting stars (small streaks) ---------- */
.shooting-star {
  position: absolute;
  width: 2px;
  height: 80px;
  background: linear-gradient(white, rgba(255,255,255,0.0));
  opacity: 0.9;
  transform: rotate(45deg);
  animation: shoot 1.5s cubic-bezier(.2,.9,.2,1) forwards;
  z-index: 5;
}
@keyframes shoot {
  from { transform: translate(-50%,-50%) rotate(45deg); opacity:1; }
  to   { transform: translate(420px, -420px) rotate(45deg); opacity:0; }
}

/* ---------- Breathing linked star expansion class ---------- */
.breathing-star {
  transition: transform 1200ms cubic-bezier(.2,.9,.2,1);
}

/* ---------- Heart sparkles (changed to star-style sparkles for clarity) ---------- */
/* NOTE: we keep class name 'heart-sparkle' in case your code references it.
   But visually they're star-particles (non-text), crisp and quick. */
.heart-sparkle {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffdff8 0%, #ffe7f4 35%, rgba(255,255,255,0.85) 60%, transparent 100%);
  box-shadow: 0 4px 10px rgba(255,160,210,0.25), 0 0 6px rgba(255,245,255,0.12);
  pointer-events: none;
  transform-origin: center center;
  animation: sparklePop 900ms cubic-bezier(.2,.9,.2,1) forwards;
  z-index: 30;
}
@keyframes sparklePop {
  0%   { transform: scale(0.4) translateY(0); opacity: 1; filter: blur(0px); }
  60%  { transform: scale(1.2) translateY(-6px); opacity: 0.9; }
  100% { transform: scale(1.6) translateY(-16px); opacity: 0; }
}

/* ---------- starfield canvas sits behind everything ---------- */
#starfield { position:fixed; inset:0; z-index:0; display:block; background:transparent; }

/* ---------- dreamy nebula overlays (unchanged but included) ---------- */
.nebula { position:fixed; inset:0; pointer-events:none; z-index:1;
  background:
    radial-gradient(900px 420px at 12% 22%, rgba(255,140,190,0.065), transparent 10%),
    radial-gradient(700px 450px at 85% 78%, rgba(80,100,220,0.05), transparent 10%),
    radial-gradient(600px 320px at 50% 40%, rgba(255,255,255,0.02), transparent 18%);
  mix-blend-mode: screen; opacity:0.96; filter:blur(16px) saturate(120%); }

.vignette { position:fixed; inset:0; z-index:2; pointer-events:none;
  background: radial-gradient(1200px 700px at 50% 30%, rgba(0,0,0,0.06), transparent 20%),
              linear-gradient(180deg, rgba(0,0,0,0.14), rgba(0,0,0,0.34));
  mix-blend-mode:multiply; }

/* ---------- main layout stage (kept intact) ---------- */
.stage {
  position:relative; z-index:3;
  min-height:100vh; display:flex; align-items:center; justify-content:center;
  padding:28px; box-sizing:border-box;
}

/* ---------- central card (kept intact) ---------- */
.card {
  width:100%; max-width:1040px;
  display:grid; grid-template-columns: 1fr 380px; gap:26px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:18px; padding:28px;
  box-shadow: 0 36px 120px rgba(2,6,26,0.75), inset 0 1px 0 rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.03);
  backdrop-filter: blur(8px) saturate(120%);
  align-items:start;
}

@media (max-width:980px) { .card { grid-template-columns: 1fr; padding:20px; gap:18px; margin: 12px; } }

/* ---------- breathing area ---------- */
.breath-wrap { display:flex; flex-direction:column; align-items:center; gap:18px; padding:6px 4px; }
h1.title { font-family: 'Patrick Hand', cursive; font-size:clamp(1.6rem,4vw,2.6rem); margin:6px 0 0; color:var(--accentA); text-shadow: 0 10px 44px rgba(255,90,160,0.08); letter-spacing:0.6px; }
p.lead { margin:0; color:var(--muted); font-weight:500; max-width:680px; text-align:center; }

.breath-stage {
  width:360px; height:360px; border-radius:999px; display:grid; place-items:center;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.02), rgba(10,24,50,0.12) 40%);
  box-shadow: 0 30px 80px rgba(6,10,30,0.66), inset 0 6px 22px rgba(255,255,255,0.02);
  position:relative; overflow:visible; transition: transform .4s ease;
}
@media (max-width:920px){ .breath-stage { width:300px; height:300px; } }
@media (max-width:560px){ .breath-stage { width:240px; height:240px; } }

.breath-orb {
  width:200px; height:200px; border-radius:999px; display:flex; align-items:center; justify-content:center;
  background: radial-gradient(circle at 35% 28%, rgba(255,240,250,0.06), rgba(10,24,50,0.12) 80%);
  box-shadow: 0 36px 120px rgba(255,120,180,0.06), 0 10px 36px rgba(0,0,0,0.55), inset 0 10px 26px rgba(255,255,255,0.02);
  transition: transform 4000ms cubic-bezier(.2,.9,.2,1), box-shadow .7s;
  will-change: transform;
}
.breath-orb.small { transform: scale(0.78); transition-duration:4000ms; box-shadow: 0 20px 48px rgba(0,0,0,0.46); }
.breath-orb.big   { transform: scale(1.18); transition-duration:7000ms; box-shadow: 0 40px 140px rgba(255,120,180,0.07); }

.orb-label { text-align:center; pointer-events:none; font-weight:800; color:#ffdff8; font-size:1.05rem; text-shadow:0 6px 30px rgba(0,0,0,0.6); letter-spacing:0.2px; }

/* ---------- controls ---------- */
.controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; margin-top:6px; }
.btn {
  padding:12px 18px; border-radius:999px; border:0; cursor:pointer; font-weight:800; font-size:1rem;
  background: linear-gradient(90deg, var(--accentA), var(--accentB)); color:#120218;
  box-shadow: 0 12px 30px rgba(255,90,160,0.14);
  transition: transform .18s, box-shadow .18s;
}
.btn:active{ transform: translateY(1px) scale(.996); }
.btn.secondary { background:transparent; color:var(--soft-white); border:1px solid rgba(255,255,255,0.04); box-shadow:none; }
.btn:focus{ outline: none; box-shadow: 0 0 0 6px rgba(255,120,180,0.08); }

.meta { color:var(--muted); font-size:0.98rem; text-align:center; margin-top:6px; }

/* ---------- affirmations (right) ‚Äî kept & improved ---------- */
.affirm-wrap { display:flex; flex-direction:column; gap:16px; justify-content:flex-start; align-items:stretch; }
.affirm-card {
  padding:22px; border-radius:14px;
  background: linear-gradient(135deg, rgba(255,255,255,0.028), rgba(255,255,255,0.012));
  border-left: 4px solid var(--affirm-accent);
  box-shadow: 0 22px 70px rgba(0,0,0,0.55), 0 6px 20px rgba(255,120,180,0.02);
  min-height:140px; display:flex; flex-direction:column; justify-content:center; align-items:center;
  backdrop-filter: blur(6px) saturate(110%);
}
.affirm-text {
  font-weight:900; text-align:center; font-size:1.15rem; color:#fff; line-height:1.28;
  text-shadow: 0 10px 36px rgba(0,0,0,0.6); letter-spacing:0.2px;
  transition: opacity 260ms ease;
}
.small-muted { color:var(--muted); font-size:0.95rem; text-align:center; margin-top:8px; }

@media (max-width:980px){ .affirm-card { min-height:120px; padding:18px; } .affirm-text { font-size:1.08rem; } }
@media (max-width:560px){
  .card { gap:14px; padding:18px; }
  .affirm-card {
    position: sticky; bottom: 18px; z-index:6; margin: 0 -6px 0 -6px;
    border-radius:12px;
    background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.014));
    box-shadow: 0 28px 80px rgba(0,0,0,0.6);
    border-left-width:6px;
  }
  .affirm-text { font-size:1.08rem; }
  .btn { padding:12px 16px; font-size:0.98rem; }
}

/* ---------- small UI sparkle (crisp, slow drift) ---------- */
.ui-star {
  position: absolute;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: #fff;
  filter: drop-shadow(0 0 4px rgba(255,255,255,0.6));
  opacity: 0.9;
  animation: uiFloat 25s ease-in-out infinite;
  z-index: 4;
  pointer-events: none;
}
@keyframes uiFloat {
  0% { transform: translateY(0) scale(1); opacity:0.9; }
  50% { transform: translateY(-12px) scale(1.05); opacity: 1; }
  100% { transform: translateY(0) scale(1); opacity:0.9; }
}

/* ---------- utility helpers (hidden but used) ---------- */
.hide { display:none !important; visibility:hidden !important; }

/* ---------- accessibility: prefers reduced motion ---------- */
@media (prefers-reduced-motion: reduce){
  .breath-orb, .ui-star, #starfield, .shooting-star, .heart-sparkle { transition:none; animation:none; }
  body { animation: none; }
}

/* ========================================================================
   End of CSS
   ======================================================================== */
</style>
</head>
<body>

<canvas id="starfield" aria-hidden="true"></canvas>
<div class="nebula" aria-hidden="true"></div>
<div class="vignette" aria-hidden="true"></div>
<div id="uiStarsContainer" aria-hidden="true"></div>

<main class="stage" role="main">
  <section class="card" aria-label="Relaxation card with breathing and affirmations">
    <div class="breath-wrap" aria-hidden="false">
      <h1 class="title cozy-title">üêæ Cozy Care üíï</h1>
      <p class="lead">A tiny universe made just for my angel. Inhale starlight, exhale all the noise my love üí´</p>

      <div class="breath-stage" aria-live="polite">
        <div class="breath-orb small" id="breathOrb" aria-hidden="false">
          <div class="orb-label" id="breathLabel">Ready</div>
        </div>
      </div>

      <div class="controls" role="group" aria-label="breathing controls">
        <button class="btn" id="startBtn" aria-pressed="false">Start Breathing</button>
        <button class="btn secondary" id="stopBtn">Stop</button>
         <audio id="myAudio" preload="none">
  <source src="https://drive.google.com/uc?export=download&id=1vc7dUhP0UwIBK7HbgcE6eBMnAF4toyvp" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>
      </div>

<!-- Play/Pause Button -->
<button class="btn secondary" id="audioToggle" aria-label="Toggle background audio" title="Toggle audio">üéµ</button>

      <div class="meta" id="cycleMeta" aria-live="polite">Cycle: 0 ‚Ä¢ Phase: idle ‚Ä¢ Time left: ‚Äî</div>
      <div class="footer-cta small-muted">Tap anywhere for little stars to magically appear</div>
    </div>

    <aside class="affirm-wrap" aria-hidden="false">
      <div class="affirm-card" role="region" aria-label="Gentle affirmations for Divanshi">
        <div class="affirm-text" id="affirmText">You are doing amazing, Divanshi üíõ</div>
        <div class="small-muted">Relax my love, your moment it is to be</div>
      </div>
    </aside>
  </section>
</main>

<div id="constellationLayer" aria-hidden="true" style="position:fixed; inset:0; pointer-events:none; z-index:4;"></div>

<script>
/* ========================================================================
   Starry Night ‚Äî Refined JS (CSS untouched)
   Adjustments:
   - Unified animation loops (less setInterval)
   - Reduced global leaks, clearer modular blocks
   - Smoothed parallax & timers via rAF
   - More robust scheduling & cleanup
   - Fixed malformed audio tag, simple toggle
   ======================================================================== */
document.addEventListener('DOMContentLoaded', () => {

  /* Utilities */
  const rand = (min, max) => Math.random() * (max - min) + min;
  const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
  const $ = sel => document.querySelector(sel);

  /* ================= STARFIELD CANVAS ================= */
  (function starfieldModule(){
    const canvas = $('#starfield');
    if(!canvas) return;
    const ctx = canvas.getContext('2d', { alpha:true });
    let width=0, height=0, dpr=1;
    let stars = [];
    let mx = innerWidth/2, my = innerHeight/2;
    let running = true;

    const baseDiv = () => (innerWidth < 560 ? 8000 : innerWidth < 920 ? 7000 : 6000);

    const resize = () => {
      dpr = Math.max(1, window.devicePixelRatio || 1);
      width = innerWidth;
      height = innerHeight;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      canvas.width = Math.round(width * dpr);
      canvas.height = Math.round(height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      const area = width * height;
      const count = Math.max(80, Math.round(area / baseDiv()));
      createStars(count);
    };

    const createStars = count => {
      stars = Array.from({length:count}, () => ({
        x: Math.random()*width,
        y: Math.random()*height,
        r: Math.pow(Math.random(),2)*(1.9+Math.random()*0.6)+0.35,
        baseAlpha: rand(0.28,0.95),
        twinkleSpeed: rand(0.002,0.014),
        phase: Math.random()*Math.PI*2,
        hueShift: rand(-8,18),
        breathingScale: 1
      }));
    };

    let lastTime = performance.now();
    let parallaxAccum = 0;

    const frame = (now) => {
      if(!running) return;
      const dt = Math.min(50, now - lastTime);
      lastTime = now;

      ctx.clearRect(0,0,width,height);
      const g = ctx.createLinearGradient(0,0,0,height);
      g.addColorStop(0,'rgba(5,12,30,0.22)');
      g.addColorStop(1,'rgba(0,3,12,0.48)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,width,height);

      // Parallax every ~50ms for a softer, cheaper shift
      parallaxAccum += dt;
      if (parallaxAccum > 50) {
        const cx = width/2, cy = height/2;
        const dx = (mx - cx)/cx;
        const dy = (my - cy)/cy;
        const adj = 0.12;
        stars.forEach(s => {
          const factor = adj - Math.min(0.10, s.r/16);
            s.x += dx * factor;
            s.y += dy * factor;
            if (s.x < -20) s.x = width + 20;
            else if (s.x > width + 20) s.x = -20;
            if (s.y < -20) s.y = height + 20;
            else if (s.y > height + 20) s.y = -20;
        });
        parallaxAccum = 0;
      }

      stars.forEach(s => {
        s.phase += s.twinkleSpeed * (dt/16);
        const a = s.baseAlpha * (0.6 + 0.4 * Math.sin(s.phase));
        const r = s.r * s.breathingScale;
        const cx = s.x, cy = s.y;

        const rad = ctx.createRadialGradient(cx, cy, 0, cx, cy, r*8);
        rad.addColorStop(0, `rgba(255,${240+Math.round(s.hueShift)},255,${(a*0.92).toFixed(3)})`);
        rad.addColorStop(0.5, `rgba(255,255,255,${(a*0.45).toFixed(3)})`);
        rad.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.beginPath();
        ctx.fillStyle = rad;
        ctx.arc(cx,cy,r*8,0,Math.PI*2);
        ctx.fill();

        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${Math.min(1,a+0.14).toFixed(3)})`;
        ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.fill();
      });

      requestAnimationFrame(frame);
    };

    const addClickSparkles = e => {
      for (let i=0;i<8;i++) {
        stars.push({
          x: e.clientX + rand(-12,12),
          y: e.clientY + rand(-12,12),
          r: rand(0.8,2.6),
          baseAlpha: rand(0.8,1),
          twinkleSpeed: rand(0.02,0.07),
          phase: Math.random()*Math.PI*2,
          hueShift: rand(-6,18),
          breathingScale: 1
        });
      }
      setTimeout(() => {
        const cap = Math.max(80, Math.round((width*height)/baseDiv()));
        if (stars.length > cap) stars.length = cap;
      }, 2600);
    };

    window.addEventListener('pointermove', e => { mx = e.clientX; my = e.clientY; }, {passive:true});
    window.addEventListener('touchmove', e => {
      if(e.touches?.[0]) { mx = e.touches[0].clientX; my = e.touches[0].clientY; }
    }, {passive:true});
    window.addEventListener('click', addClickSparkles);

    const onVisibility = () => { running = !document.hidden; if (running) { lastTime = performance.now(); requestAnimationFrame(frame); } };
    document.addEventListener('visibilitychange', onVisibility);

    let resizeRaf;
    window.addEventListener('resize', () => {
      cancelAnimationFrame(resizeRaf);
      resizeRaf = requestAnimationFrame(() => { resize(); });
    });

    resize();
    requestAnimationFrame(frame);

    window.__Starfield = {
      starsArray: stars,
      setBreathScaleForAll(scale){ stars.forEach(s => s.breathingScale = scale); },
      getStarsRef: () => stars
    };
  })();

  /* ========== UI Decorative Stars ========== */
  (function uiStars(){
    const container = $('#uiStarsContainer');
    if(!container) return;
    const count = innerWidth < 560 ? 90 : (innerWidth < 920 ? 140 : 210);
    const frag = document.createDocumentFragment();
    for (let i=0;i<count;i++){
      const el = document.createElement('div');
      el.className = 'ui-star';
      el.style.left = (Math.random()*100) + '%';
      el.style.top = (Math.random()*100) + '%';
      el.style.opacity = (0.45 + Math.random()*0.55).toFixed(2);
      const size = (2 + Math.random()*4);
      el.style.width = size + 'px';
      el.style.height = size + 'px';
      el.style.transform = `scale(${(0.5 + Math.random()*1.6).toFixed(2)})`;
      el.style.animationDelay = (Math.random()*6) + 's';
      el.style.animationDuration = (20 + Math.random()*28) + 's';
      frag.appendChild(el);
    }
    container.appendChild(frag);
  })();

  /* ========== Shooting Stars ========== */
  (function shootingStars(){
    const spawn = () => {
      const star = document.createElement('div');
      star.className = 'shooting-star';
      star.style.left = (Math.random()*innerWidth*0.7) + 'px';
      star.style.top = (Math.random()*innerHeight*0.35) + 'px';
      const len = 60 + Math.random()*180;
      star.style.height = len + 'px';
      star.style.opacity = (0.6 + Math.random()*0.4).toString();
      document.body.appendChild(star);
      setTimeout(()=> star.remove(), 1600 + Math.random()*800);
    };
    const schedule = () => {
      const delay = 4200 + Math.random()*8000;
      setTimeout(() => {
        const count = Math.random() < 0.18 ? 2 : 1;
        for (let i=0;i<count;i++) setTimeout(spawn, i*150 + Math.random()*300);
        schedule();
      }, delay);
    };
    schedule();
  })();

  /* ========== Constellations ========== */
  (function constellations(){
    const layer = $('#constellationLayer');
    if(!layer) return;
    const svgNS = "http://www.w3.org/2000/svg";

    const pickRandomStars = n => {
      const sf = window.__Starfield;
      if(!sf?.getStarsRef) return [];
      const arr = sf.getStarsRef();
      const out = [];
      for (let i=0;i<n;i++){
        const st = arr[Math.floor(Math.random()*arr.length)];
        if (st) out.push({x: st.x, y: st.y});
      }
      return out;
    };

    const draw = () => {
      const pts = pickRandomStars(3 + Math.floor(Math.random()*3));
      if (pts.length < 3) return;
      const svg = document.createElementNS(svgNS,'svg');
      svg.setAttribute('width','100%');
      svg.setAttribute('height','100%');
      svg.setAttribute('viewBox',`0 0 ${innerWidth} ${innerHeight}`);
      svg.style.position='absolute';
      svg.style.left='0';
      svg.style.top='0';
      svg.setAttribute('preserveAspectRatio','none');

      const path = document.createElementNS(svgNS,'path');
      path.setAttribute('d', pts.map((p,i)=> (i?'L ':'M ') + p.x + ' ' + p.y).join(' '));
      path.setAttribute('stroke','rgba(255,230,255,0.12)');
      path.setAttribute('stroke-width','1.2');
      path.setAttribute('fill','none');
      path.style.opacity='0';
      path.style.transition='opacity 700ms ease, transform 900ms ease';
      svg.appendChild(path);
      layer.appendChild(svg);

      requestAnimationFrame(()=>{
        path.style.opacity='1';
        path.style.transform='translateY(-6px)';
      });

      setTimeout(()=>{
        path.style.opacity='0';
        path.style.transform='translateY(-16px)';
        setTimeout(()=> svg.remove(), 1200);
      }, 1400 + Math.random()*1600);
    };

    let constellationTimer = 0;
    const tick = (t)=>{
      if (document.hidden) { requestAnimationFrame(tick); return; }
      if (!constellationTimer) constellationTimer = t;
      if (t - constellationTimer > 4200 + Math.random()*3400) {
        constellationTimer = t;
        if (Math.random() < 0.45) draw();
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  })();

  /* ========== Tap Sparkles ========== */
  (function tapSparkles(){
    const createSparkle = (x,y,hueShift) => {
      const el = document.createElement('div');
      el.className = 'heart-sparkle';
      el.style.left = (x - 6) + 'px';
      el.style.top = (y - 6) + 'px';
      el.style.filter = `hue-rotate(${hueShift}deg)`;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 950 + Math.random()*300);
    };
    window.addEventListener('pointerdown', e=>{
      if (e.target.closest('.btn,.controls,button')) return;
      const burst = 8 + Math.floor(Math.random()*6);
      for (let i=0;i<burst;i++){
        setTimeout(()=> createSparkle(e.pageX + rand(-10,10), e.pageY + rand(-10,10), rand(-6,10)), i*18);
      }
    }, {passive:true});
  })();

  /* ========== Breathing Logic ========== */
  (function breathing(){
    const startBtn = $('#startBtn');
    const stopBtn  = $('#stopBtn');
    const orb      = $('#breathOrb');
    const label    = $('#breathLabel');
    const meta     = $('#cycleMeta');

    const inhale = 7, hold = 8, exhale = 4;
    let running=false, cycle=0, phase='idle', timeLeft=0;
    let phaseTimeout=null, countdownRaf=null, lastCountdown=0;

    function updateMeta(){
      meta.textContent = `Cycle: ${cycle} ‚Ä¢ Phase: ${phase} ‚Ä¢ Time left: ${timeLeft ? timeLeft.toFixed(1)+'s' : '‚Äî'}`;
    }

    function applyBreathToStars(scale){
      window.__Starfield?.setBreathScaleForAll(scale);
      document.querySelectorAll('.ui-star').forEach(s=>{
        s.style.transform = `scale(${scale})`;
        s.classList.add('breathing-star');
        setTimeout(()=> s.classList.remove('breathing-star'), 1400);
      });
    }

    function onPhaseChange(p){
      if (p==='inhale') applyBreathToStars(1.18);
      else if (p==='hold') applyBreathToStars(1.05);
      else if (p==='exhale') applyBreathToStars(0.92);
      else applyBreathToStars(1.0);
    }
    window.onBreathPhaseChange = onPhaseChange;

    function setPhase(next){
      phase = next;
      if (next==='inhale'){
        timeLeft = inhale;
        label.textContent = 'Inhale';
        orb.classList.remove('small'); orb.classList.add('big');
      } else if (next==='hold'){
        timeLeft = hold;
        label.textContent = 'Hold';
      } else if (next==='exhale'){
        timeLeft = exhale;
        label.textContent = 'Exhale';
        orb.classList.remove('big'); orb.classList.add('small');
      } else {
        timeLeft = 0;
        label.textContent = 'Stopped';
      }
      onPhaseChange(next);
      updateMeta();
      schedulePhaseAdvance();
    }

    function schedulePhaseAdvance(){
      clearTimeout(phaseTimeout);
      if (!running) return;
      const duration = (phase==='inhale'? inhale : phase==='hold'? hold : exhale) * 1000;
      phaseTimeout = setTimeout(()=>{
        if (!running) return;
        if (phase==='inhale') setPhase('hold');
        else if (phase==='hold') setPhase('exhale');
        else if (phase==='exhale'){ cycle++; setPhase('inhale'); }
      }, duration);
    }

    function countdown(now){
      if (!running){ countdownRaf=null; return; }
      if (!lastCountdown) lastCountdown = now;
      const delta = now - lastCountdown;
      if (delta >= 100) {
        if (timeLeft > 0) {
          timeLeft = Math.max(0, timeLeft - delta/1000);
          updateMeta();
        }
        lastCountdown = now;
      }
      countdownRaf = requestAnimationFrame(countdown);
    }

    function start(){
      if (running) return;
      running = true; cycle = 0;
      setPhase('inhale');
      lastCountdown = 0;
      countdownRaf = requestAnimationFrame(countdown);
    }

    function stop(){
      running = false;
      clearTimeout(phaseTimeout);
      label.textContent = 'Stopped';
      phase='idle'; timeLeft=0; updateMeta();
      onPhaseChange('idle');
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
    document.addEventListener('keydown', e=>{
      if (e.key === ' ') { e.preventDefault(); running ? stop() : start(); }
    });
    document.addEventListener('visibilitychange', ()=> { if (document.hidden) stop(); });

    window.__BreathControls = { start, stop, getState:()=>({running, phase, cycle}) };
  })();

  /* ========== Affirmations ========== */
  (function affirmations(){
    const AFFIRMATIONS = [
      "I am cherished, and I will cherish my life with love and affection üíù",
      "I can do it, and I will do it üí´",
      "Breathe in starlight, breathe out these noise ‚ú®",
      "I am a warrior, one of the strongest ones ‚ú®",
      "I am enough and loved just the way I am üíû",
      "I am Shakti, I am the universe itself üíñ",
      "I am proud of myself, I am a warrior üíì",
      "I am loved unconditionally and endlessly üíï",
      "Relax, I am doing good enough ‚ù£Ô∏è",
      "I am doing beautifully üíå",
      "I have power, I have control over myself and my thoughts üåü"
    ];
    const display = $('#affirmText');
    if (!display) return;
    let idx = 0;
    let nextChange = performance.now() + 5000;
    let paused = false;

    function show(i){
      idx = (i + AFFIRMATIONS.length) % AFFIRMATIONS.length;
      display.style.opacity = 0;
      setTimeout(()=>{
        display.textContent = AFFIRMATIONS[idx];
        display.style.opacity = 1;
      }, 220);
    }

    function loop(now){
      if (!document.hidden && !paused && now >= nextChange){
        show(idx+1);
        nextChange = now + 5000;
      }
      requestAnimationFrame(loop);
    }
    show(0);
    requestAnimationFrame(loop);

    display.addEventListener('dblclick', ()=>{
      const custom = prompt('Edit affirmation (local only):', display.textContent);
      if (custom && custom.trim()){
        AFFIRMATIONS[idx] = custom.trim();
        show(idx);
      }
    });
  })();

  /* ========== Title Safeguard ========== */
  (function ensureTitle(){
    const t = document.querySelector('.title');
    if (t && !t.classList.contains('cozy-title')) t.classList.add('cozy-title');
  })();

  /* ========== Audio Toggle (Optional) ========== */
  (function audioControl(){
    const audio = $('#myAudio');
    const btn = $('#audioToggle');
    if (!audio || !btn) return;
    let playing = false;
    const setState = () => {
      btn.textContent = playing ? 'üîá' : 'üéµ';
      btn.setAttribute('aria-pressed', playing);
    };
    btn.addEventListener('click', async () => {
      try {
        if (!playing){
          await audio.play();
          playing = true;
        } else {
          audio.pause();
          playing = false;
        }
        setState();
      } catch (e){
        console.warn('Audio play prevented:', e);
      }
    });
    setState();
  })();

  /* ========== Debug Helper ========== */
  window.__TinyUniverse = window.__TinyUniverse || {};
  window.__TinyUniverse.debugInfo = () => ({
    starsDOM: document.querySelectorAll('.ui-star').length,
    canvasStarsEstimate: window.__Starfield?.getStarsRef()?.length ?? 'n/a'
  });

});
</script>

</body>
</html>
